{
	"name": "DF_Review_Duplicate",
	"properties": {
		"description": "Output Duplicate Review report.  Currently ties to the union csv in blob.",
		"folder": {
			"name": "Client/Audit Reports"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Source_FactTbl_AllCoreData_File",
						"type": "DatasetReference"
					},
					"name": "CorePromotions"
				},
				{
					"dataset": {
						"referenceName": "Source_FactTbl_TalentData_File",
						"type": "DatasetReference"
					},
					"name": "Talent"
				},
				{
					"dataset": {
						"referenceName": "Source_FactTbl_JobReq_File",
						"type": "DatasetReference"
					},
					"name": "Requisitions"
				},
				{
					"dataset": {
						"referenceName": "Source_FactTbl_Applicant_File",
						"type": "DatasetReference"
					},
					"name": "Applicants"
				},
				{
					"dataset": {
						"referenceName": "Source_FactTbl_AllCoreData_File",
						"type": "DatasetReference"
					},
					"name": "CoreHeadcount"
				},
				{
					"dataset": {
						"referenceName": "Source_FactTbl_AllCoreData_File",
						"type": "DatasetReference"
					},
					"name": "CoreTerminations"
				},
				{
					"dataset": {
						"referenceName": "Source_FactTbl_AllCoreData_File",
						"type": "DatasetReference"
					},
					"name": "CoreHires"
				},
				{
					"dataset": {
						"referenceName": "Source_FactTbl_OtherCore_File",
						"type": "DatasetReference"
					},
					"name": "Other"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "Source_AuditFolder",
						"type": "DatasetReference"
					},
					"name": "EventDuplicatesReport"
				}
			],
			"transformations": [
				{
					"name": "HeadcountRowCount"
				},
				{
					"name": "HeadcountSumRowsForDups"
				},
				{
					"name": "HctDuplicates"
				},
				{
					"name": "TerminationsRowCount"
				},
				{
					"name": "TerminationsSumRowsForDups"
				},
				{
					"name": "TermDuplicates"
				},
				{
					"name": "union1"
				},
				{
					"name": "HiresRowCount"
				},
				{
					"name": "HiresSumRowsForDups"
				},
				{
					"name": "HireDuplicates"
				},
				{
					"name": "PromotionsRowCount"
				},
				{
					"name": "PromotionsSumRowsForDups"
				},
				{
					"name": "PromoDuplicates"
				},
				{
					"name": "TalentRowCount"
				},
				{
					"name": "TalentSumRowsForDups"
				},
				{
					"name": "TalentDuplicates"
				},
				{
					"name": "RequisitionsRowCount"
				},
				{
					"name": "RequisitionsSumRowsForDups"
				},
				{
					"name": "RequisitionDuplicates"
				},
				{
					"name": "ApplicantRowCount"
				},
				{
					"name": "ApplicantSumRowsForDups"
				},
				{
					"name": "ApplicantDuplicates"
				},
				{
					"name": "PromoFilterOutClientAliasHeaderRow"
				},
				{
					"name": "HeadcountFilter"
				},
				{
					"name": "TerminationFilter"
				},
				{
					"name": "HiresFilter"
				},
				{
					"name": "FinalSelect"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "sort1"
				},
				{
					"name": "OtherRowCount"
				},
				{
					"name": "OtherSumRowsForDups"
				},
				{
					"name": "ConcatEventandEventType"
				},
				{
					"name": "OtherDuplicates"
				},
				{
					"name": "RemoveNullOtherRows"
				},
				{
					"name": "RemoveNullPromoRows"
				},
				{
					"name": "RemoveNullTalentRows"
				},
				{
					"name": "RemoveNullReqRows"
				},
				{
					"name": "RemoveNullApplicantRows"
				},
				{
					"name": "RemoveNullHeadcountRows"
				},
				{
					"name": "RemoveNullTermRows"
				},
				{
					"name": "RemoveNullHireRows"
				}
			],
			"scriptLines": [
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          EventMonth as string,",
				"          {Event Quarter} as string,",
				"          {Event Year} as string,",
				"          {Worker ID} as string,",
				"          {Event Date} as string,",
				"          {Event Code} as string,",
				"          {Event Type} as string,",
				"          Event as string,",
				"          {Event Reason} as string,",
				"          {Worker Type} as string,",
				"          {Job Title} as string,",
				"          {Job Function} as string,",
				"          {Years in Job} as string,",
				"          {Previous Job Title} as string,",
				"          {Previous Job Function} as string,",
				"          {Original Hire Date} as string,",
				"          {Current Hire Date} as string,",
				"          {Years of Service} as string,",
				"          {Years of Service Band} as string,",
				"          {Years of Service Sort ID} as string,",
				"          {Last Promo Date} as string,",
				"          {Rehire Indicator} as string,",
				"          {Corporate Title} as string,",
				"          {Previous Corporate Title} as string,",
				"          {Manager Indicator} as string,",
				"          {Direct Manager Worker ID} as string,",
				"          {Work Office Location} as string,",
				"          {Work City} as string,",
				"          {Work State} as string,",
				"          {Work Country} as string,",
				"          {Strategic Work Location Ind} as string,",
				"          {Legacy Organization} as string,",
				"          {Business Group Level 1} as string,",
				"          {Business Group Level 2} as string,",
				"          {Business Group Level 3} as string,",
				"          {Business Group Level 4} as string,",
				"          Race as string,",
				"          {Hispanic or Latino Origin} as string,",
				"          Gender as string,",
				"          {Veteran Ind} as string,",
				"          LGBTQ as string,",
				"          {Disability Ind} as string,",
				"          {Birth Year} as string,",
				"          {Generation Desc} as string,",
				"          {Generation Sort ID} as string,",
				"          EmpCount as string,",
				"          RowCount as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> CorePromotions",
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          {Event Year} as string,",
				"          {Event Date} as string,",
				"          Event as string,",
				"          {Event Type} as string,",
				"          {Worker ID} as string,",
				"          {Performance Rating} as string,",
				"          {Performance Rating Date} as string,",
				"          {Talent Identifier (1)} as string,",
				"          {Talent Identifier (2)} as string,",
				"          {Talent Identifier (3)} as string,",
				"          {Talent Identifier (4)} as string,",
				"          {Talent Identifier (5)} as string,",
				"          {Salary Range} as string,",
				"          Bonus as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> Talent",
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          {Client Engagement Type} as string,",
				"          {Event Date} as string,",
				"          EventMonth as string,",
				"          {Event Quarter} as string,",
				"          {Event Year} as string,",
				"          EventId as string,",
				"          Event as string,",
				"          {Requisition ID} as string,",
				"          {Requisition Type} as string,",
				"          {Posting Date} as string,",
				"          {Requisition Status} as string,",
				"          {Number of Openings} as string,",
				"          {Job Title} as string,",
				"          {Job Function} as string,",
				"          {Corporate Title} as string,",
				"          {Work Office Location} as string,",
				"          {Work Office City} as string,",
				"          {Work Office State} as string,",
				"          {Work Office Country} as string,",
				"          {Strategic Work Location Ind} as string,",
				"          {Business Group Level 1} as string,",
				"          {Business Group Level 2} as string,",
				"          {Business Group Level 3} as string,",
				"          {Business Group Level 4} as string,",
				"          {Hiring Manager Worker ID} as string,",
				"          {Primary Recruiter Worker ID} as string,",
				"          {Requisition Other (1)} as string,",
				"          {Requisition Other (2)} as string,",
				"          {Requisition Other (3)} as string,",
				"          {Requisition Other (4)} as string,",
				"          {Requisition Other (5)} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> Requisitions",
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          {Event Date} as string,",
				"          EventMonth as string,",
				"          {Event Quarter} as string,",
				"          {Event Year} as string,",
				"          Event as string,",
				"          {Requisition ID} as string,",
				"          {Applicant ID} as string,",
				"          Source as string,",
				"          {Applicant Type} as string,",
				"          {Internal Worker ID} as string,",
				"          Race as string,",
				"          {Hispanic or Latino Origin} as string,",
				"          Gender as string,",
				"          {Veteran Ind} as string,",
				"          LGTBQ as string,",
				"          {Disability Ind} as string,",
				"          {Applicant Final Disposition} as string,",
				"          {Applicant Step Before Final Disposition} as string,",
				"          {Applicant Rejected Reason} as string,",
				"          {Applicant Other (1)} as string,",
				"          {Applicant Other (2)} as string,",
				"          {Applicant Other (3)} as string,",
				"          {Applicant Other (4)} as string,",
				"          {Applicant Other (5)} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> Applicants",
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          EventMonth as string,",
				"          {Event Quarter} as string,",
				"          {Event Year} as string,",
				"          {Worker ID} as string,",
				"          {Event Date} as string,",
				"          {Event Code} as string,",
				"          {Event Type} as string,",
				"          Event as string,",
				"          {Event Reason} as string,",
				"          {Worker Type} as string,",
				"          {Job Title} as string,",
				"          {Job Function} as string,",
				"          {Years in Job} as string,",
				"          {Previous Job Title} as string,",
				"          {Previous Job Function} as string,",
				"          {Original Hire Date} as string,",
				"          {Current Hire Date} as string,",
				"          {Years of Service} as string,",
				"          {Years of Service Band} as string,",
				"          {Years of Service Sort ID} as string,",
				"          {Last Promo Date} as string,",
				"          {Rehire Indicator} as string,",
				"          {Corporate Title} as string,",
				"          {Previous Corporate Title} as string,",
				"          {Manager Indicator} as string,",
				"          {Direct Manager Worker ID} as string,",
				"          {Work Office Location} as string,",
				"          {Work City} as string,",
				"          {Work State} as string,",
				"          {Work Country} as string,",
				"          {Strategic Work Location Ind} as string,",
				"          {Legacy Organization} as string,",
				"          {Business Group Level 1} as string,",
				"          {Business Group Level 2} as string,",
				"          {Business Group Level 3} as string,",
				"          {Business Group Level 4} as string,",
				"          Race as string,",
				"          {Hispanic or Latino Origin} as string,",
				"          Gender as string,",
				"          {Veteran Ind} as string,",
				"          LGBTQ as string,",
				"          {Disability Ind} as string,",
				"          {Birth Year} as string,",
				"          {Generation Desc} as string,",
				"          {Generation Sort ID} as string,",
				"          EmpCount as string,",
				"          RowCount as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> CoreHeadcount",
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          EventMonth as string,",
				"          {Event Quarter} as string,",
				"          {Event Year} as string,",
				"          {Worker ID} as string,",
				"          {Event Date} as string,",
				"          {Event Code} as string,",
				"          {Event Type} as string,",
				"          Event as string,",
				"          {Event Reason} as string,",
				"          {Worker Type} as string,",
				"          {Job Title} as string,",
				"          {Job Function} as string,",
				"          {Years in Job} as string,",
				"          {Previous Job Title} as string,",
				"          {Previous Job Function} as string,",
				"          {Original Hire Date} as string,",
				"          {Current Hire Date} as string,",
				"          {Years of Service} as string,",
				"          {Years of Service Band} as string,",
				"          {Years of Service Sort ID} as string,",
				"          {Last Promo Date} as string,",
				"          {Rehire Indicator} as string,",
				"          {Corporate Title} as string,",
				"          {Previous Corporate Title} as string,",
				"          {Manager Indicator} as string,",
				"          {Direct Manager Worker ID} as string,",
				"          {Work Office Location} as string,",
				"          {Work City} as string,",
				"          {Work State} as string,",
				"          {Work Country} as string,",
				"          {Strategic Work Location Ind} as string,",
				"          {Legacy Organization} as string,",
				"          {Business Group Level 1} as string,",
				"          {Business Group Level 2} as string,",
				"          {Business Group Level 3} as string,",
				"          {Business Group Level 4} as string,",
				"          Race as string,",
				"          {Hispanic or Latino Origin} as string,",
				"          Gender as string,",
				"          {Veteran Ind} as string,",
				"          LGBTQ as string,",
				"          {Disability Ind} as string,",
				"          {Birth Year} as string,",
				"          {Generation Desc} as string,",
				"          {Generation Sort ID} as string,",
				"          EmpCount as string,",
				"          RowCount as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> CoreTerminations",
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          EventMonth as string,",
				"          {Event Quarter} as string,",
				"          {Event Year} as string,",
				"          {Worker ID} as string,",
				"          {Event Date} as string,",
				"          {Event Code} as string,",
				"          {Event Type} as string,",
				"          Event as string,",
				"          {Event Reason} as string,",
				"          {Worker Type} as string,",
				"          {Job Title} as string,",
				"          {Job Function} as string,",
				"          {Years in Job} as string,",
				"          {Previous Job Title} as string,",
				"          {Previous Job Function} as string,",
				"          {Original Hire Date} as string,",
				"          {Current Hire Date} as string,",
				"          {Years of Service} as string,",
				"          {Years of Service Band} as string,",
				"          {Years of Service Sort ID} as string,",
				"          {Last Promo Date} as string,",
				"          {Corporate Title} as string,",
				"          {Previous Corporate Title} as string,",
				"          {Manager Indicator} as string,",
				"          {Direct Manager Worker ID} as string,",
				"          {Work Office Location} as string,",
				"          {Work City} as string,",
				"          {Work State} as string,",
				"          {Work Country} as string,",
				"          {Strategic Work Location Ind} as string,",
				"          {Legacy Organization} as string,",
				"          {Business Group Level 1} as string,",
				"          {Business Group Level 2} as string,",
				"          {Business Group Level 3} as string,",
				"          {Business Group Level 4} as string,",
				"          Race as string,",
				"          {Hispanic or Latino Origin} as string,",
				"          Gender as string,",
				"          {Veteran Ind} as string,",
				"          LGBTQ as string,",
				"          {Disability Ind} as string,",
				"          {Birth Year} as string,",
				"          {Generation Desc} as string,",
				"          {Generation Sort ID} as string,",
				"          EmpCount as string,",
				"          RowCount as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> CoreHires",
				"source(output(",
				"          {Client ID} as string,",
				"          {Client Engagement Date} as string,",
				"          {Worker ID} as string,",
				"          {Event Date} as string,",
				"          EventMonth as string,",
				"          {Event Quarter} as string,",
				"          {Event Year} as string,",
				"          {Event ID} as string,",
				"          Event as string,",
				"          {Event (Type)} as string,",
				"          {Event (Desc)} as string,",
				"          {Other (Char Value 1)} as string,",
				"          {Other (Char Value 2)} as string,",
				"          {Other (Num Value 1)} as string,",
				"          {Other (Num Value 2)} as string,",
				"          {Other (Date Value 1)} as string,",
				"          {Other (Date Value 2)} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> Other",
				"HeadcountFilter aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     RowCount = count({Worker ID})) ~> HeadcountRowCount",
				"HeadcountRowCount aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     DuplicateCount = sum(RowCount)) ~> HeadcountSumRowsForDups",
				"RemoveNullHeadcountRows filter(DuplicateCount>1) ~> HctDuplicates",
				"TerminationFilter aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     RowCount = count({Worker ID})) ~> TerminationsRowCount",
				"TerminationsRowCount aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     DuplicateCount = sum(RowCount)) ~> TerminationsSumRowsForDups",
				"RemoveNullTermRows filter(DuplicateCount>1) ~> TermDuplicates",
				"HctDuplicates, TermDuplicates, HireDuplicates, PromoDuplicates, TalentDuplicates, RequisitionDuplicates, ApplicantDuplicates, OtherDuplicates union(byName: true)~> union1",
				"HiresFilter aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     RowCount = countAll({Worker ID})) ~> HiresRowCount",
				"HiresRowCount aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     DuplicateCount = sum(RowCount)) ~> HiresSumRowsForDups",
				"RemoveNullHireRows filter(DuplicateCount>1) ~> HireDuplicates",
				"PromoFilterOutClientAliasHeaderRow aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     RowCount = count({Worker ID})) ~> PromotionsRowCount",
				"PromotionsRowCount aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     DuplicateCount = sum(RowCount)) ~> PromotionsSumRowsForDups",
				"RemoveNullPromoRows filter(DuplicateCount>1) ~> PromoDuplicates",
				"Talent aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     RowCount = count({Worker ID})) ~> TalentRowCount",
				"TalentRowCount aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Record Id (Worker/Req/Applicant)} = {Worker ID}),",
				"     DuplicateCount = sum(RowCount)) ~> TalentSumRowsForDups",
				"RemoveNullTalentRows filter(DuplicateCount>1) ~> TalentDuplicates",
				"Requisitions aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Requisition ID}),",
				"     RowCount = count({Requisition ID})) ~> RequisitionsRowCount",
				"RequisitionsRowCount aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Record Id (Worker/Req/Applicant)} = {Requisition ID}),",
				"     DuplicateCount = sum(RowCount)) ~> RequisitionsSumRowsForDups",
				"RemoveNullReqRows filter(DuplicateCount>1) ~> RequisitionDuplicates",
				"Applicants aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Applicant ID},",
				"          {Requisition ID}),",
				"     RowCount = count({Applicant ID})) ~> ApplicantRowCount",
				"ApplicantRowCount aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Record Id (Worker/Req/Applicant)} = {Applicant ID},",
				"          {Requisition ID}),",
				"     DuplicateCount = sum(RowCount)) ~> ApplicantSumRowsForDups",
				"RemoveNullApplicantRows filter(DuplicateCount>1) ~> ApplicantDuplicates",
				"CorePromotions filter({Event Code}=='PRO') ~> PromoFilterOutClientAliasHeaderRow",
				"CoreHeadcount filter({Event Code}=='HCT') ~> HeadcountFilter",
				"CoreTerminations filter({Event Code}=='TER') ~> TerminationFilter",
				"CoreHires filter({Event Code}=='HIR') ~> HiresFilter",
				"derivedColumn1 select(mapColumn(",
				"          Event,",
				"          {Event Date},",
				"          {Record Id (Worker/Req/Applicant)},",
				"          DuplicateCount",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> FinalSelect",
				"ApplicantSumRowsForDups derive({Record Id (Worker/Req/Applicant)} = toString({Record Id (Worker/Req/Applicant)})) ~> derivedColumn1",
				"union1 sort(asc(Event, true)) ~> sort1",
				"Other aggregate(groupBy(Event,",
				"          {Event (Desc)},",
				"          {Event (Type)},",
				"          {Event Date},",
				"          {Worker ID}),",
				"     RowCount = countAll({Worker ID})) ~> OtherRowCount",
				"ConcatEventandEventType aggregate(groupBy(Event,",
				"          {Event Date},",
				"          {Worker ID}),",
				"     DuplicateCount = sum(RowCount)) ~> OtherSumRowsForDups",
				"OtherRowCount derive(Event = concat(concat(concat(concat(Event,' '),{Event (Type)}),' '),{Event (Desc)})) ~> ConcatEventandEventType",
				"RemoveNullOtherRows filter(DuplicateCount>1) ~> OtherDuplicates",
				"OtherSumRowsForDups filter(!(isNull(Event))) ~> RemoveNullOtherRows",
				"PromotionsSumRowsForDups filter(!(isNull(Event))) ~> RemoveNullPromoRows",
				"TalentSumRowsForDups filter(!(isNull(Event))) ~> RemoveNullTalentRows",
				"RequisitionsSumRowsForDups filter(!(isNull(Event))) ~> RemoveNullReqRows",
				"FinalSelect filter(!(isNull(Event))) ~> RemoveNullApplicantRows",
				"HeadcountSumRowsForDups filter(!(isNull(Event))) ~> RemoveNullHeadcountRows",
				"TerminationsSumRowsForDups filter(!(isNull(Event))) ~> RemoveNullTermRows",
				"HiresSumRowsForDups filter(!(isNull(Event))) ~> RemoveNullHireRows",
				"sort1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['Template - Duplicates Review Core.csv'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> EventDuplicatesReport"
			]
		}
	}
}